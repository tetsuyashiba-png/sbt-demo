<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³ƒè²¸å€Ÿå¥‘ç´„ SBTç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .network-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #4caf50;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }

        .network-badge.disconnected {
            background: #ff5722;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 20px 0;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .sbt-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .sbt-display h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .sbt-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .link:hover {
            text-decoration: underline;
        }

        .instructions {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #666;
        }

        .instructions li {
            margin: 8px 0;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .contract-info {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .contract-info p {
            color: #666;
            font-size: 13px;
            margin: 5px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ  è³ƒè²¸å€Ÿå¥‘ç´„ KYC SBTç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #666; margin-top: 10px;">ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã§è­²æ¸¡ä¸å¯èƒ½ãªå…¥å±…è€…è¨¼æ˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ</p>
            
            <div class="wallet-info">
                <div>
                    <span class="network-badge disconnected" id="networkBadge">æœªæ¥ç¶š</span>
                    <span id="walletAddress" style="margin-left: 15px; color: #666;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæœªæ¥ç¶š</span>
                </div>
                <button class="btn" id="connectBtn" onclick="connectWallet()">MetaMaskæ¥ç¶š</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left: Mint SBT -->
            <div class="card">
                <h2>ğŸ“ SBTç™ºè¡Œ</h2>
                
                <div class="form-group">
                    <label>æ°å</label>
                    <input type="text" id="userName" value="å±±ç”° å¤ªéƒ" placeholder="å…¥å±…è€…æ°å">
                </div>

                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="userId" value="USER_2024_001" placeholder="ä¸€æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
                </div>

                <div class="form-group">
                    <label>ç‰©ä»¶ä½æ‰€</label>
                    <input type="text" id="propertyAddress" value="æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹1-2-3" placeholder="å¥‘ç´„ç‰©ä»¶ä½æ‰€">
                </div>

                <div class="form-group">
                    <label>KYCãƒ¬ãƒ™ãƒ«</label>
                    <select id="kycLevel">
                        <option value="1">åŸºæœ¬èªè¨¼</option>
                        <option value="2" selected>æ‹¡å¼µèªè¨¼</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æœ‰åŠ¹æœŸé–“ï¼ˆå¹´ï¼‰</label>
                    <input type="number" id="validityYears" value="2" min="1" max="10">
                </div>

                <button class="btn" id="mintBtn" onclick="mintSBT()" disabled>
                    SBTã‚’ç™ºè¡Œ
                </button>

                <div id="mintStatus"></div>

                <div class="instructions">
                    <h3>âš ï¸ ä½¿ç”¨æ–¹æ³•</h3>
                    <ol>
                        <li>MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</li>
                        <li>Sepolia ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆ</li>
                        <li>ãƒ†ã‚¹ãƒˆETHã‚’å–å¾—ï¼ˆfaucetä½¿ç”¨ï¼‰</li>
                        <li>ã€ŒMetaMaskæ¥ç¶šã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€ŒSBTã‚’ç™ºè¡Œã€</li>
                    </ol>
                </div>
            </div>

            <!-- Right: View SBT -->
            <div class="card">
                <h2>ğŸ« SBTç¢ºèª</h2>
                
                <div class="form-group">
                    <label>ç¢ºèªã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="text" id="checkAddress" placeholder="0x...">
                    <button class="btn" onclick="checkSBT()" style="margin-top: 10px; width: 100%;">
                        SBTã‚’ç¢ºèª
                    </button>
                </div>

                <div id="sbtDisplay"></div>
                
                <div class="contract-info">
                    <h3 style="color: #333; margin-bottom: 10px;">ğŸ“‹ ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæƒ…å ±</h3>
                    <p><strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:</strong> Sepolia Testnet</p>
                    <p><strong>ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:</strong></p>
                    <p id="contractAddress" style="font-family: monospace; font-size: 12px;">ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <p style="margin-top: 10px;"><strong>æ³¨æ„:</strong> ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã§ã™ã€‚å®Ÿéš›ã®ä¾¡å€¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆè¨­å®šï¼ˆå®Ÿéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›´æ–°ï¼‰
        const CONTRACT_ADDRESS = "0xc9b1821620146021536f9962933773e5437693F9";
        
        const CONTRACT_ABI = [
            "function mintSBT(address to, string memory userId, uint256 validityPeriod, bytes32 propertyHash, uint8 kycLevel) public returns (uint256)",
            "function getSBTData(uint256 tokenId) public view returns (tuple(string userId, uint256 issuedDate, uint256 expiryDate, bytes32 propertyHash, uint8 kycLevel, bool isValid))",
            "function addressToTokenId(address) public view returns (uint256)",
            "function hasValidSBT(address account) public view returns (bool)",
            "function isValidSBT(uint256 tokenId) public view returns (bool)",
            "event SBTMinted(address indexed to, uint256 indexed tokenId, string userId)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼');
                    return;
                }

                // MetaMaskæ¥ç¶š
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª
                const network = await provider.getNetwork();
                
                document.getElementById('walletAddress').textContent = 
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                
                if (network.chainId === 11155111) { // Sepolia
                    document.getElementById('networkBadge').textContent = 'Sepolia';
                    document.getElementById('networkBadge').classList.remove('disconnected');
                    
                    // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                    if (CONTRACT_ADDRESS !== "YOUR_CONTRACT_ADDRESS_HERE") {
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                        document.getElementById('mintBtn').disabled = false;
                        document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;
                    } else {
                        showStatus('mintStatus', 'info', 'âš ï¸ ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    }
                } else {
                    document.getElementById('networkBadge').textContent = 'é–“é•ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯';
                    showStatus('mintStatus', 'error', 'Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                }

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                showStatus('mintStatus', 'error', 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // SBTç™ºè¡Œ
        async function mintSBT() {
            try {
                const mintBtn = document.getElementById('mintBtn');
                mintBtn.disabled = true;
                
                showStatus('mintStatus', 'info', '<span class="loading"></span>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­...');

                const userId = document.getElementById('userId').value;
                const propertyAddress = document.getElementById('propertyAddress').value;
                const kycLevel = parseInt(document.getElementById('kycLevel').value);
                const validityYears = parseInt(document.getElementById('validityYears').value);
                
                // ç‰©ä»¶ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
                const propertyHash = ethers.utils.id(propertyAddress);
                
                // æœ‰åŠ¹æœŸé–“ã‚’ç§’ã«å¤‰æ›ï¼ˆå¹´ * 365æ—¥ * 24æ™‚é–“ * 60åˆ† * 60ç§’ï¼‰
                const validityPeriod = validityYears * 365 * 24 * 60 * 60;
                
                // SBTç™ºè¡Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
                const tx = await contract.mintSBT(
                    userAddress,
                    userId,
                    validityPeriod,
                    propertyHash,
                    kycLevel
                );
                
                showStatus('mintStatus', 'info', '<span class="loading"></span>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã§ã®ç¢ºèªã‚’å¾…ã£ã¦ã„ã¾ã™...');
                
                const receipt = await tx.wait();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³IDã‚’å–å¾—
                const event = receipt.events.find(e => e.event === 'SBTMinted');
                const tokenId = event.args.tokenId.toString();
                
                showStatus('mintStatus', 'success', 
                    `âœ… SBTç™ºè¡ŒæˆåŠŸï¼<br>
                    ãƒˆãƒ¼ã‚¯ãƒ³ID: ${tokenId}<br>
                    Tx: <a href="https://sepolia.etherscan.io/tx/${receipt.transactionHash}" target="_blank" class="link">${receipt.transactionHash.substring(0, 10)}...</a>`
                );
                
                mintBtn.disabled = false;
                
                // è‡ªå‹•çš„ã«SBTã‚’è¡¨ç¤º
                document.getElementById('checkAddress').value = userAddress;
                setTimeout(() => checkSBT(), 2000);
                
            } catch (error) {
                console.error('Mint ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('mintStatus', 'error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                document.getElementById('mintBtn').disabled = false;
            }
        }

        // SBTç¢ºèª
        async function checkSBT() {
            try {
                const address = document.getElementById('checkAddress').value;
                
                if (!ethers.utils.isAddress(address)) {
                    showStatus('sbtDisplay', 'error', 'ç„¡åŠ¹ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™');
                    return;
                }
                
                if (!contract) {
                    document.getElementById('sbtDisplay').innerHTML = 
                        '<div class="status error">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„</div>';
                    return;
                }

                const tokenId = await contract.addressToTokenId(address);
                
                if (tokenId.toString() === '0') {
                    document.getElementById('sbtDisplay').innerHTML = 
                        '<div class="status info">ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯SBTã‚’ä¿æœ‰ã—ã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }
                
                const sbtData = await contract.getSBTData(tokenId);
                const isValid = await contract.isValidSBT(tokenId);
                
                const issuedDate = new Date(sbtData.issuedDate.toNumber() * 1000);
                const expiryDate = new Date(sbtData.expiryDate.toNumber() * 1000);
                
                document.getElementById('sbtDisplay').innerHTML = `
                    <div class="sbt-display">
                        <h3>ğŸ« å…¥å±…è€…è¨¼æ˜SBT</h3>
                        <div class="sbt-info"><strong>ãƒˆãƒ¼ã‚¯ãƒ³ID:</strong> ${tokenId.toString()}</div>
                        <div class="sbt-info"><strong>User ID:</strong> ${sbtData.userId}</div>
                        <div class="sbt-info"><strong>ç™ºè¡Œæ—¥:</strong> ${issuedDate.toLocaleDateString('ja-JP')}</div>
                        <div class="sbt-info"><strong>æœ‰åŠ¹æœŸé™:</strong> ${expiryDate.toLocaleDateString('ja-JP')}</div>
                        <div class="sbt-info"><strong>KYCãƒ¬ãƒ™ãƒ«:</strong> ${sbtData.kycLevel === 1 ? 'åŸºæœ¬èªè¨¼' : 'æ‹¡å¼µèªè¨¼'}</div>
                        <div class="sbt-info"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${isValid ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹/æœŸé™åˆ‡ã‚Œ'}</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                showStatus('sbtDisplay', 'error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, type, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤‰æ›´ã‚’æ¤œçŸ¥
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
            
            window.ethereum.on('accountsChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
