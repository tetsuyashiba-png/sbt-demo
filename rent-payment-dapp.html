<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è³ƒæ”¯æ‰•ã„ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .network-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #4caf50;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }

        .network-badge.disconnected {
            background: #ff5722;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .balance-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-group {
            margin: 20px 0;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .distribution {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }

        .distribution-item {
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }

        .distribution-item .percentage {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .distribution-item .label {
            color: #666;
            margin-top: 10px;
            font-size: 14px;
        }

        .distribution-item .amount {
            font-size: 20px;
            color: #333;
            margin-top: 5px;
        }

        .payment-history {
            margin-top: 20px;
        }

        .payment-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .payment-item .date {
            font-size: 12px;
            color: #666;
        }

        .payment-item .amount {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin: 5px 0;
        }

        .link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .link:hover {
            text-decoration: underline;
        }

        .info-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ’° å®¶è³ƒæ”¯æ‰•ã„ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #666; margin-top: 10px;">ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ã‚¤ãƒ³ã§å®¶è³ƒã‚’æ”¯æ‰•ã„ã€è‡ªå‹•ã§å¤§å®¶ã¨ç®¡ç†ä¼šç¤¾ã«åˆ†é…</p>
            
            <div class="wallet-info">
                <div>
                    <span class="network-badge disconnected" id="networkBadge">æœªæ¥ç¶š</span>
                    <span id="walletAddress" style="margin-left: 15px; color: #666;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæœªæ¥ç¶š</span>
                </div>
                <button class="btn" id="connectBtn" onclick="connectWallet()">MetaMaskæ¥ç¶š</button>
            </div>
        </div>

        <!-- SBT Status Card -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>ğŸ« SBTèªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            <div id="sbtStatus">
                <p style="color: #666; text-align: center; padding: 20px;">
                    ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦SBTèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                </p>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left: Pay Rent -->
            <div class="card">
                <h2>ğŸ’³ å®¶è³ƒæ”¯æ‰•ã„</h2>
                
                <div class="balance-display">
                    <div class="balance-label">ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é«˜</div>
                    <div class="balance-amount" id="tokenBalance">0</div>
                    <div class="balance-label">TJPY</div>
                </div>

                <div class="form-group">
                    <label>æ”¯æ‰•ã„é‡‘é¡ï¼ˆTJPYï¼‰</label>
                    <input type="number" id="paymentAmount" value="120000" placeholder="ä¾‹: 120000">
                </div>

                <div class="info-box">
                    <strong>ğŸ’¡ è‡ªå‹•åˆ†é…:</strong><br>
                    æ”¯æ‰•ã„ã¨åŒæ™‚ã«å¤§å®¶ã«95%ã€ç®¡ç†ä¼šç¤¾ã«5%ãŒè‡ªå‹•ã§é€é‡‘ã•ã‚Œã¾ã™
                </div>

                <button class="btn" id="approveBtn" onclick="approveToken()" disabled>
                    ã‚¹ãƒ†ãƒƒãƒ—1: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ã‚’æ‰¿èª
                </button>

                <button class="btn secondary" id="payBtn" onclick="payRent()" disabled style="margin-top: 10px;">
                    ã‚¹ãƒ†ãƒƒãƒ—2: å®¶è³ƒã‚’æ”¯æ‰•ã†
                </button>

                <div id="paymentStatus"></div>
            </div>

            <!-- Right: Payment Result -->
            <div class="card">
                <h2>ğŸ“Š æ”¯æ‰•ã„çµæœ</h2>
                
                <div id="resultDisplay">
                    <p style="color: #666; text-align: center; padding: 40px 0;">
                        æ”¯æ‰•ã„å¾Œã€ã“ã“ã«åˆ†é…çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </p>
                </div>

                <div class="payment-history">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“œ æ”¯æ‰•ã„å±¥æ­´</h3>
                    <div id="historyDisplay">
                        <p style="color: #666; text-align: center; padding: 20px;">
                            ã¾ã æ”¯æ‰•ã„å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card" style="margin-top: 20px;">
            <h2>ğŸ“‹ ä½¿ã„æ–¹</h2>
            <ol style="margin-left: 20px; color: #666; line-height: 1.8;">
                <li>ã€ŒMetaMaskæ¥ç¶šã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li><strong>SBTèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª</strong>ï¼ˆæœ‰åŠ¹ãªSBTãŒãªã„å ´åˆã¯ç®¡ç†è€…ã«é€£çµ¡ï¼‰</li>
                <li>ãƒˆãƒ¼ã‚¯ãƒ³æ®‹é«˜ã‚’ç¢ºèªï¼ˆæ®‹é«˜ãŒå°‘ãªã„å ´åˆã¯ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã€ã§è¿½åŠ ï¼‰</li>
                <li>æ”¯æ‰•ã„é‡‘é¡ã‚’å…¥åŠ›</li>
                <li>ã€Œã‚¹ãƒ†ãƒƒãƒ—1: ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ã‚’æ‰¿èªã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ã€Œã‚¹ãƒ†ãƒƒãƒ—2: å®¶è³ƒã‚’æ”¯æ‰•ã†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>è‡ªå‹•çš„ã«å¤§å®¶95%ã€ç®¡ç†ä¼šç¤¾5%ã«åˆ†é…ã•ã‚Œã¾ã™</li>
            </ol>
        </div>
    </div>

    <script>
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹
        const TOKEN_ADDRESS = "0x179AFB0E44838E42D30953Da6f344479558e2Ef3";
        const RENT_PAYMENT_ADDRESS = "0x77d1251Edac77cF4e4b8339dD74CECD61f90902b";
        const SBT_CONTRACT_ADDRESS = "0xFE585e9240d4891c4f92aFbF33Aa55CE80Df6514";
        
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://vdnmxuzltbarhxquqybg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k0fjXuvHuZWp2rLlsLVfBw_rnoIVdJxZH0wSI04lZ-MsKXlOYDQIU';
        
        const TOKEN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function mint(uint256 amount) external",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        const RENT_PAYMENT_ABI = [
            "function payRent(address tokenAddress, uint256 amount) external",
            "function getTenantPayments(address tenant) external view returns (uint256[] memory)",
            "function getPaymentDetails(uint256 paymentId) external view returns (address tenant, uint256 amount, uint256 timestamp, address tokenAddress, bool isDistributed)",
            "function landlord() external view returns (address)",
            "function managementCompany() external view returns (address)",
            "event RentPaid(address indexed tenant, uint256 amount, address indexed tokenAddress, uint256 timestamp, uint256 paymentId)",
            "event RentDistributed(uint256 indexed paymentId, address indexed landlord, uint256 landlordAmount, address indexed managementCompany, uint256 managementAmount)"
        ];

        const SBT_ABI = [
            "function addressToTokenId(address) external view returns (uint256)",
            "function hasValidSBT(address account) external view returns (bool)",
            "function getSBTData(uint256 tokenId) external view returns (tuple(string userId, uint256 issuedDate, uint256 expiryDate, bytes32 propertyHash, uint8 kycLevel, bool isValid))",
            "function isValidSBT(uint256 tokenId) external view returns (bool)"
        ];

        let provider;
        let signer;
        let tokenContract;
        let rentContract;
        let sbtContract;
        let userAddress;

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                
                document.getElementById('walletAddress').textContent = 
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                
                if (network.chainId === 11155111) {
                    document.getElementById('networkBadge').textContent = 'Sepolia';
                    document.getElementById('networkBadge').classList.remove('disconnected');
                    
                    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
                    rentContract = new ethers.Contract(RENT_PAYMENT_ADDRESS, RENT_PAYMENT_ABI, signer);
                    sbtContract = new ethers.Contract(SBT_CONTRACT_ADDRESS, SBT_ABI, provider);
                    
                    // SBTèªè¨¼ãƒã‚§ãƒƒã‚¯
                    await checkSBT();
                    
                    await updateBalance();
                    await loadPaymentHistory();
                } else {
                    document.getElementById('networkBadge').textContent = 'é–“é•ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯';
                    showStatus('paymentStatus', 'error', 'Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                }

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                showStatus('paymentStatus', 'error', 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // SBTèªè¨¼ãƒã‚§ãƒƒã‚¯
        async function checkSBT() {
            try {
                showSBTStatus('info', '<span class="loading"></span>SBTèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
                
                const hasValid = await sbtContract.hasValidSBT(userAddress);
                
                if (!hasValid) {
                    const tokenId = await sbtContract.addressToTokenId(userAddress);
                    
                    if (tokenId.toNumber() === 0) {
                        // SBTæœªç™ºè¡Œ
                        showSBTStatus('error', `
                            âŒ <strong>SBTãŒæœªç™ºè¡Œã§ã™</strong><br><br>
                            å®¶è³ƒã®æ”¯æ‰•ã„ã«ã¯SBTèªè¨¼ãŒå¿…è¦ã§ã™ã€‚<br>
                            ç®¡ç†è€…ã«é€£çµ¡ã—ã¦KYCèªè¨¼ã‚’å®Œäº†ã—ã€SBTã‚’ç™ºè¡Œã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚
                        `);
                        document.getElementById('approveBtn').disabled = true;
                        document.getElementById('payBtn').disabled = true;
                        return;
                    } else {
                        // SBTç„¡åŠ¹ï¼ˆæœŸé™åˆ‡ã‚Œç­‰ï¼‰
                        const sbtData = await sbtContract.getSBTData(tokenId);
                        const expiryDate = new Date(sbtData.expiryDate.toNumber() * 1000);
                        
                        showSBTStatus('error', `
                            âŒ <strong>SBTã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™</strong><br><br>
                            <div style="margin-top: 10px; color: #666;">
                                <strong>User ID:</strong> ${sbtData.userId}<br>
                                <strong>Token ID:</strong> ${tokenId.toNumber()}<br>
                                <strong>æœ‰åŠ¹æœŸé™:</strong> ${expiryDate.toLocaleDateString('ja-JP')}<br>
                            </div><br>
                            ç®¡ç†è€…ã«é€£çµ¡ã—ã¦SBTã®æ›´æ–°ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚
                        `);
                        document.getElementById('approveBtn').disabled = true;
                        document.getElementById('payBtn').disabled = true;
                        return;
                    }
                }
                
                // SBTæœ‰åŠ¹
                const tokenId = await sbtContract.addressToTokenId(userAddress);
                const sbtData = await sbtContract.getSBTData(tokenId);
                const issuedDate = new Date(sbtData.issuedDate.toNumber() * 1000);
                const expiryDate = new Date(sbtData.expiryDate.toNumber() * 1000);
                
                showSBTStatus('success', `
                    âœ… <strong>SBTèªè¨¼æ¸ˆã¿</strong><br><br>
                    <div style="margin-top: 10px; color: #2e7d32;">
                        <strong>User ID:</strong> ${sbtData.userId}<br>
                        <strong>Token ID:</strong> ${tokenId.toNumber()}<br>
                        <strong>KYCãƒ¬ãƒ™ãƒ«:</strong> ${sbtData.kycLevel === 1 ? 'åŸºæœ¬' : 'æ‹¡å¼µ'}<br>
                        <strong>ç™ºè¡Œæ—¥:</strong> ${issuedDate.toLocaleDateString('ja-JP')}<br>
                        <strong>æœ‰åŠ¹æœŸé™:</strong> ${expiryDate.toLocaleDateString('ja-JP')}
                    </div>
                `);
                
                document.getElementById('approveBtn').disabled = false;
                
            } catch (error) {
                console.error('SBTãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                showSBTStatus('error', `
                    âŒ <strong>SBTç¢ºèªã‚¨ãƒ©ãƒ¼</strong><br><br>
                    ${error.message}
                `);
                document.getElementById('approveBtn').disabled = true;
                document.getElementById('payBtn').disabled = true;
            }
        }

        // SBTã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showSBTStatus(type, message) {
            document.getElementById('sbtStatus').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        // æ®‹é«˜æ›´æ–°
        async function updateBalance() {
            try {
                const balance = await tokenContract.balanceOf(userAddress);
                const decimals = await tokenContract.decimals();
                const formatted = ethers.utils.formatUnits(balance, decimals);
                document.getElementById('tokenBalance').textContent = parseFloat(formatted).toLocaleString();
            } catch (error) {
                console.error('æ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æ‰¿èª
        async function approveToken() {
            try {
                const approveBtn = document.getElementById('approveBtn');
                approveBtn.disabled = true;
                
                showStatus('paymentStatus', 'info', '<span class="loading"></span>æ‰¿èªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­...');

                const amount = document.getElementById('paymentAmount').value;
                const decimals = await tokenContract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);
                
                const tx = await tokenContract.approve(RENT_PAYMENT_ADDRESS, amountWei);
                
                showStatus('paymentStatus', 'info', '<span class="loading"></span>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã§ã®ç¢ºèªã‚’å¾…ã£ã¦ã„ã¾ã™...');
                
                await tx.wait();
                
                showStatus('paymentStatus', 'success', 
                    'âœ… æ‰¿èªæˆåŠŸï¼æ¬¡ã«ã€Œã‚¹ãƒ†ãƒƒãƒ—2: å®¶è³ƒã‚’æ”¯æ‰•ã†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
                
                document.getElementById('payBtn').disabled = false;
                
            } catch (error) {
                console.error('æ‰¿èªã‚¨ãƒ©ãƒ¼:', error);
                showStatus('paymentStatus', 'error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                document.getElementById('approveBtn').disabled = false;
            }
        }

        // å®¶è³ƒæ”¯æ‰•ã„
        async function payRent() {
            try {
                const payBtn = document.getElementById('payBtn');
                payBtn.disabled = true;
                
                showStatus('paymentStatus', 'info', '<span class="loading"></span>æ”¯æ‰•ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­...');

                const amount = document.getElementById('paymentAmount').value;
                const decimals = await tokenContract.decimals();
                const amountWei = ethers.utils.parseUnits(amount, decimals);
                
                const tx = await rentContract.payRent(TOKEN_ADDRESS, amountWei);
                
                showStatus('paymentStatus', 'info', '<span class="loading"></span>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã§ã®ç¢ºèªã‚’å¾…ã£ã¦ã„ã¾ã™...');
                
                const receipt = await tx.wait();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—
                const paidEvent = receipt.events.find(e => e.event === 'RentPaid');
                const distributedEvent = receipt.events.find(e => e.event === 'RentDistributed');
                
                if (distributedEvent) {
                    const landlordAmount = ethers.utils.formatUnits(distributedEvent.args.landlordAmount, decimals);
                    const managementAmount = ethers.utils.formatUnits(distributedEvent.args.managementAmount, decimals);
                    
                    document.getElementById('resultDisplay').innerHTML = `
                        <div class="distribution">
                            <div class="distribution-item">
                                <div class="percentage">95%</div>
                                <div class="label">å¤§å®¶</div>
                                <div class="amount">${parseFloat(landlordAmount).toLocaleString()} TJPY</div>
                            </div>
                            <div class="distribution-item">
                                <div class="percentage">5%</div>
                                <div class="label">ç®¡ç†ä¼šç¤¾</div>
                                <div class="amount">${parseFloat(managementAmount).toLocaleString()} TJPY</div>
                            </div>
                        </div>
                        <div class="status success">
                            âœ… æ”¯æ‰•ã„æˆåŠŸï¼<br>
                            Tx: <a href="https://sepolia.etherscan.io/tx/${receipt.transactionHash}" target="_blank" class="link">${receipt.transactionHash.substring(0, 10)}...</a>
                        </div>
                    `;
                }
                
                showStatus('paymentStatus', 'success', 'âœ… å®¶è³ƒæ”¯æ‰•ã„å®Œäº†ï¼è‡ªå‹•åˆ†é…ã•ã‚Œã¾ã—ãŸ');
                
                await updateBalance();
                await loadPaymentHistory();
                
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('payBtn').disabled = true;
                
            } catch (error) {
                console.error('æ”¯æ‰•ã„ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('paymentStatus', 'error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                document.getElementById('payBtn').disabled = false;
            }
        }

        // æ”¯æ‰•ã„å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadPaymentHistory() {
            try {
                const paymentIds = await rentContract.getTenantPayments(userAddress);
                
                if (paymentIds.length === 0) {
                    return;
                }
                
                let historyHTML = '';
                const decimals = await tokenContract.decimals();
                
                for (let i = paymentIds.length - 1; i >= 0; i--) {
                    const details = await rentContract.getPaymentDetails(paymentIds[i]);
                    const amount = ethers.utils.formatUnits(details.amount, decimals);
                    const date = new Date(details.timestamp.toNumber() * 1000);
                    
                    historyHTML += `
                        <div class="payment-item">
                            <div class="date">${date.toLocaleString('ja-JP')}</div>
                            <div class="amount">${parseFloat(amount).toLocaleString()} TJPY</div>
                            <div style="font-size: 12px; color: #666;">
                                ${details.isDistributed ? 'âœ… åˆ†é…æ¸ˆã¿' : 'â³ å‡¦ç†ä¸­'}
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('historyDisplay').innerHTML = historyHTML;
                
            } catch (error) {
                console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, type, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤‰æ›´ã‚’æ¤œçŸ¥
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
            
            window.ethereum.on('accountsChanged', () => {
                window.location.reload();
            });
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        async function mintToken() {
            try {
                showStatus('paymentStatus', 'info', '<span class="loading"></span>ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ä¸­...');
                const decimals = await tokenContract.decimals();
                const amount = ethers.utils.parseUnits('500000', decimals);
                const tx = await tokenContract.mint(amount);
                await tx.wait();
                showStatus('paymentStatus', 'success', 'âœ… 500,000 TJPY ã‚’å–å¾—ã—ã¾ã—ãŸï¼');
                await updateBalance();
            } catch (error) {
                showStatus('paymentStatus', 'error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        document.addEventListener('DOMContentLoaded', () => {
            const balanceDisplay = document.querySelector('.balance-display');
            const mintBtn = document.createElement('button');
            mintBtn.className = 'btn';
            mintBtn.textContent = 'ğŸª™ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰';
            mintBtn.onclick = mintToken;
            mintBtn.style.marginTop = '15px';
            mintBtn.style.fontSize = '14px';
            mintBtn.style.padding = '8px 20px';
            balanceDisplay.appendChild(mintBtn);
        });
    </script>
</body>
</html>
