<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³ƒè²¸å€Ÿå¥‘ç´„ SBTç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .network-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #4caf50;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }

        .network-badge.disconnected {
            background: #ff5722;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 20px 0;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .sbt-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .sbt-display h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .sbt-info {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .link {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .link:hover {
            text-decoration: underline;
        }

        .instructions {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }

        .instructions h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #666;
        }

        .instructions li {
            margin: 8px 0;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .contract-info {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .contract-info p {
            color: #666;
            font-size: 13px;
            margin: 5px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ  è³ƒè²¸å€Ÿå¥‘ç´„ KYC SBTç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: #666; margin-top: 10px;">ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã§è­²æ¸¡ä¸å¯èƒ½ãªå…¥å±…è€…è¨¼æ˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ</p>
            
            <div class="wallet-info">
                <div>
                    <span class="network-badge disconnected" id="networkBadge">æœªæ¥ç¶š</span>
                    <span id="walletAddress" style="margin-left: 15px; color: #666;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæœªæ¥ç¶š</span>
                </div>
                <button class="btn" id="connectBtn" onclick="connectWallet()">MetaMaskæ¥ç¶š</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Left: Mint SBT -->
            <div class="card">
                <h2>ğŸ“ SBTç™ºè¡Œ</h2>
                
                <div class="form-group">
                    <label>æ°å</label>
                    <input type="text" id="userName" value="å±±ç”° å¤ªéƒ" placeholder="å…¥å±…è€…æ°å">
                </div>

                <div class="form-group">
                    <label>å…¥å±…è€…ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color: #f44336;">*</span></label>
                    <input type="text" id="recipientAddress" placeholder="0x..." style="font-family: monospace;">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        å…¥å±…è€…ã®MetaMaskã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                    </p>
                </div>

                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="userId" value="USER_2024_001" placeholder="ä¸€æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
                </div>

                <div class="form-group">
                    <label>ç‰©ä»¶ä½æ‰€</label>
                    <input type="text" id="propertyAddress" value="æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹1-2-3" placeholder="å¥‘ç´„ç‰©ä»¶ä½æ‰€">
                </div>

                <div class="form-group">
                    <label>KYCãƒ¬ãƒ™ãƒ«</label>
                    <select id="kycLevel">
                        <option value="1">åŸºæœ¬èªè¨¼</option>
                        <option value="2" selected>æ‹¡å¼µèªè¨¼</option>
                    </select>
                </div>

                <div class="form-group" style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin: 20px 0;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ” æœ¬äººç¢ºèªï¼ˆKYCï¼‰</h3>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="kycIcChip" style="width: auto; margin-right: 10px; cursor: pointer; transform: scale(1.2);">
                            <span>ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ICãƒãƒƒãƒ—èª­ã¿å–ã‚Š</span>
                        </label>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="kycFaceToFace" style="width: auto; margin-right: 10px; cursor: pointer; transform: scale(1.2);">
                            <span>ç®¡ç†ä¼šç¤¾ã«ã‚ˆã‚‹å¯¾é¢ã§ã®æœ¬äººç¢ºèª</span>
                        </label>
                    </div>
                    
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        â€» æ‹¡å¼µèªè¨¼ã‚’é¸æŠã™ã‚‹å ´åˆã¯ã€ä¸¡æ–¹ã®ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦ã§ã™
                    </p>
                </div>

                <div class="form-group">
                    <label>æœ‰åŠ¹æœŸé–“ï¼ˆå¹´ï¼‰</label>
                    <input type="number" id="validityYears" value="2" min="1" max="10">
                </div>

                <button class="btn" id="mintBtn" onclick="mintSBT()" disabled>
                    SBTã‚’ç™ºè¡Œ
                </button>

                <div id="mintStatus"></div>

                <div class="instructions">
                    <h3>âš ï¸ ä½¿ç”¨æ–¹æ³•</h3>
                    <ol>
                        <li>MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</li>
                        <li>Sepolia ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆ</li>
                        <li>ãƒ†ã‚¹ãƒˆETHã‚’å–å¾—ï¼ˆfaucetä½¿ç”¨ï¼‰</li>
                        <li>ã€ŒMetaMaskæ¥ç¶šã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€ŒSBTã‚’ç™ºè¡Œã€</li>
                    </ol>
                </div>
            </div>

            <!-- Right: View SBT -->
            <div class="card">
                <h2>ğŸ« SBTç¢ºèª</h2>
                
                <div class="form-group">
                    <label>ç¢ºèªã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="text" id="checkAddress" placeholder="0x...">
                    <button class="btn" onclick="checkSBT()" style="margin-top: 10px; width: 100%;">
                        SBTã‚’ç¢ºèª
                    </button>
                </div>

                <div id="sbtDisplay"></div>
                
                <div class="contract-info">
                    <h3 style="color: #333; margin-bottom: 10px;">ğŸ“‹ ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæƒ…å ±</h3>
                    <p><strong>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯:</strong> Sepolia Testnet</p>
                    <p><strong>ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:</strong></p>
                    <p id="contractAddress" style="font-family: monospace; font-size: 12px;">æ¥ç¶šå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <p style="margin-top: 10px;"><strong>æ³¨æ„:</strong> ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã§ã™ã€‚å®Ÿéš›ã®ä¾¡å€¤ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆè¨­å®šï¼ˆæœ€æ–°ç‰ˆï¼‰
        const CONTRACT_ADDRESS = "0xFE585e9240d4891c4f92aFbF33Aa55CE80Df6514";
        
        const CONTRACT_ABI = [
            "function mintSBT(address to, string memory userId, uint256 validityPeriod, bytes32 propertyHash, uint8 kycLevel) public returns (uint256)",
            "function getSBTData(uint256 tokenId) public view returns (tuple(string userId, uint256 issuedDate, uint256 expiryDate, bytes32 propertyHash, uint8 kycLevel, bool isValid))",
            "function addressToTokenId(address) public view returns (uint256)",
            "function hasValidSBT(address account) public view returns (bool)",
            "function isValidSBT(uint256 tokenId) public view returns (bool)",
            "event SBTMinted(address indexed to, uint256 indexed tokenId, string userId)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                
                document.getElementById('walletAddress').textContent = 
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                
                if (network.chainId === 11155111) {
                    document.getElementById('networkBadge').textContent = 'Sepolia';
                    document.getElementById('networkBadge').classList.remove('disconnected');
                    
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    document.getElementById('mintBtn').disabled = false;
                    document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;
                    
                    showStatus('mintStatus', 'success', 'âœ… æ¥ç¶šæˆåŠŸï¼SBTã®ç™ºè¡ŒãŒå¯èƒ½ã§ã™');
                } else {
                    document.getElementById('networkBadge').textContent = 'é–“é•ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯';
                    showStatus('mintStatus', 'error', 'Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                }

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                showStatus('mintStatus', 'error', 'ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // SBTç™ºè¡Œ
        async function mintSBT() {
            try {
                const mintBtn = document.getElementById('mintBtn');
                mintBtn.disabled = true;
                
                const kycLevel = parseInt(document.getElementById('kycLevel').value);
                const kycIcChip = document.getElementById('kycIcChip').checked;
                const kycFaceToFace = document.getElementById('kycFaceToFace').checked;
                
                // æ‹¡å¼µèªè¨¼ã®å ´åˆã€ä¸¡æ–¹ã®ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦
                if (kycLevel === 2 && (!kycIcChip || !kycFaceToFace)) {
                    showStatus('mintStatus', 'error', 'âŒ æ‹¡å¼µèªè¨¼ã‚’é¸æŠã™ã‚‹å ´åˆã¯ã€ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ICãƒãƒƒãƒ—èª­ã¿å–ã‚Šã¨å¯¾é¢æœ¬äººç¢ºèªã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™');
                    mintBtn.disabled = false;
                    return;
                }
                
                const recipientAddress = document.getElementById('recipientAddress').value;
                
                if (!recipientAddress || !ethers.utils.isAddress(recipientAddress)) {
                    showStatus('mintStatus', 'error', 'âŒ æœ‰åŠ¹ãªå…¥å±…è€…ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    mintBtn.disabled = false;
                    return;
                }
                
                // ã™ã§ã«SBTã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                try {
                    const existingTokenId = await contract.addressToTokenId(recipientAddress);
                    if (existingTokenId.toNumber() !== 0) {
                        showStatus('mintStatus', 'error', `âŒ ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã™ã§ã«SBT (Token ID: ${existingTokenId}) ã‚’ä¿æœ‰ã—ã¦ã„ã¾ã™`);
                        mintBtn.disabled = false;
                        return;
                    }
                } catch (error) {
                    // addressToTokenIdã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯ç¶šè¡Œ
                    console.log('æ—¢å­˜SBTãƒã‚§ãƒƒã‚¯:', error);
                }
                
                showStatus('mintStatus', 'info', '<span class="loading"></span>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­...');

                const userId = document.getElementById('userId').value;
                const propertyAddress = document.getElementById('propertyAddress').value;
                const validityYears = parseInt(document.getElementById('validityYears').value);
                
                const propertyHash = ethers.utils.id(propertyAddress);
                const validityPeriod = validityYears * 365 * 24 * 60 * 60;
                
                const tx = await contract.mintSBT(
                    recipientAddress,
                    userId,
                    validityPeriod,
                    propertyHash,
                    kycLevel
                );
                
                showStatus('mintStatus', 'info', '<span class="loading"></span>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã§ã®ç¢ºèªã‚’å¾…ã£ã¦ã„ã¾ã™...');
                
                const receipt = await tx.wait();
                
                let tokenId = 'Unknown';
                try {
                    const event = receipt.events?.find(e => e.event === 'SBTMinted');
                    if (event && event.args && event.args.tokenId) {
                        tokenId = event.args.tokenId.toString();
                    }
                } catch (e) {
                    console.log('ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯æˆåŠŸï¼‰:', e);
                }
                
                showStatus('mintStatus', 'success', 
                    `âœ… SBTç™ºè¡ŒæˆåŠŸï¼<br>
                    å—å–äºº: ${recipientAddress.substring(0, 6)}...${recipientAddress.substring(38)}<br>
                    ${tokenId !== 'Unknown' ? `ãƒˆãƒ¼ã‚¯ãƒ³ID: ${tokenId}<br>` : ''}
                    Tx: <a href="https://sepolia.etherscan.io/tx/${receipt.transactionHash}" target="_blank" class="link">${receipt.transactionHash.substring(0, 10)}...</a>`
                );
                
                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å€‹äººæƒ…å ±ã‚’ä¿å­˜
                try {
                    const userName = document.getElementById('userName').value;
                    const SUPABASE_URL = 'https://vdnmxuzltbarhxquqybg.supabase.co';
                    const SUPABASE_KEY = 'sb_publishable_k0fjXuvHuZWp2rLlsLVfBw_rnoIVdJxZH0wSI04lZ-MsKXlOYDQIU';
                    
                    const dbResponse = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            name: userName,
                            address: propertyAddress,
                            phone: 'æœªç™»éŒ²',
                            email: 'æœªç™»éŒ²'
                        })
                    });
                    
                    if (dbResponse.ok) {
                        console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜æˆåŠŸ');
                    } else {
                        console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆSBTã¯ç™ºè¡Œæ¸ˆã¿ï¼‰');
                    }
                } catch (dbError) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', dbError);
                }
                
                mintBtn.disabled = false;
                
                // è‡ªå‹•ç¢ºèª
                document.getElementById('checkAddress').value = recipientAddress;
                setTimeout(() => checkSBT(), 2000);
                
            } catch (error) {
                console.error('Mint ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMsg = error.message;
                if (error.message.includes('Address already has an SBT')) {
                    errorMsg = 'ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã™ã§ã«SBTã‚’ä¿æœ‰ã—ã¦ã„ã¾ã™';
                }
                
                showStatus('mintStatus', 'error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + errorMsg);
                document.getElementById('mintBtn').disabled = false;
            }
        }

        // SBTç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„ç‰ˆï¼‰
        async function checkSBT() {
            try {
                const address = document.getElementById('checkAddress').value;
                
                if (!ethers.utils.isAddress(address)) {
                    document.getElementById('sbtDisplay').innerHTML = 
                        '<div class="status error">âŒ ç„¡åŠ¹ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™</div>';
                    return;
                }
                
                if (!contract) {
                    document.getElementById('sbtDisplay').innerHTML = 
                        '<div class="status error">âŒ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„</div>';
                    return;
                }

                // ã¾ãšhasValidSBTã§ç¢ºèª
                const hasValid = await contract.hasValidSBT(address);
                
                // tokenIdã‚’å–å¾—
                let tokenId;
                try {
                    tokenId = await contract.addressToTokenId(address);
                } catch (error) {
                    console.error('addressToTokenId ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('sbtDisplay').innerHTML = 
                        '<div class="status info">â„¹ï¸ ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯SBTã‚’ä¿æœ‰ã—ã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }
                
                if (tokenId.toNumber() === 0) {
                    document.getElementById('sbtDisplay').innerHTML = 
                        '<div class="status info">â„¹ï¸ ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯SBTã‚’ä¿æœ‰ã—ã¦ã„ã¾ã›ã‚“</div>';
                    return;
                }
                
                const sbtData = await contract.getSBTData(tokenId);
                const isValid = await contract.isValidSBT(tokenId);
                
                const issuedDate = new Date(sbtData.issuedDate.toNumber() * 1000);
                const expiryDate = new Date(sbtData.expiryDate.toNumber() * 1000);
                
                const statusText = isValid ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹/æœŸé™åˆ‡ã‚Œ';
                const statusColor = isValid ? '#4caf50' : '#f44336';
                
                document.getElementById('sbtDisplay').innerHTML = `
                    <div class="sbt-display">
                        <h3>ğŸ« å…¥å±…è€…è¨¼æ˜SBT</h3>
                        <div class="sbt-info"><strong>ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> ${address.substring(0, 6)}...${address.substring(38)}</div>
                        <div class="sbt-info"><strong>ãƒˆãƒ¼ã‚¯ãƒ³ID:</strong> ${tokenId.toString()}</div>
                        <div class="sbt-info"><strong>User ID:</strong> ${sbtData.userId}</div>
                        <div class="sbt-info"><strong>ç™ºè¡Œæ—¥:</strong> ${issuedDate.toLocaleDateString('ja-JP')}</div>
                        <div class="sbt-info"><strong>æœ‰åŠ¹æœŸé™:</strong> ${expiryDate.toLocaleDateString('ja-JP')}</div>
                        <div class="sbt-info"><strong>KYCãƒ¬ãƒ™ãƒ«:</strong> ${sbtData.kycLevel === 1 ? 'åŸºæœ¬èªè¨¼' : 'æ‹¡å¼µèªè¨¼'}</div>
                        <div class="sbt-info" style="background: ${statusColor}; color: white;"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${statusText}</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('sbtDisplay').innerHTML = 
                    `<div class="status error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, type, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¤‰æ›´ã‚’æ¤œçŸ¥
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
            
            window.ethereum.on('accountsChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
