<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼æ¥­SBTç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .network-badge {
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
            display: block;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
            display: block;
        }

        .info-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
        }

        .link {
            color: #667eea;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ä¼æ¥­SBTç™ºè¡Œã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="subtitle">ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³ä¼æ¥­ã«èªè¨¼SBTã‚’ç™ºè¡Œ</p>
            <div class="wallet-info">
                <div>
                    <span class="network-badge" id="networkBadge">æœªæ¥ç¶š</span>
                    <span id="walletAddress" style="margin-left: 10px; color: #666;">-</span>
                </div>
                <button class="btn" onclick="connectWallet()" style="width: auto; padding: 10px 20px;">
                    MetaMaskæ¥ç¶š
                </button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ ä¼æ¥­SBTç™ºè¡Œ</h2>
            
            <div class="info-box">
                <strong>âš ï¸ æ³¨æ„</strong><br>
                ã“ã®ãƒšãƒ¼ã‚¸ã¯ç®¡ç†è€…ï¼ˆã‚ãªãŸï¼‰ã®ã¿ãŒä½¿ç”¨ã§ãã¾ã™ã€‚<br>
                èªå¯ã•ã‚ŒãŸãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³ä¼æ¥­ã«ã®ã¿SBTã‚’ç™ºè¡Œã—ã¦ãã ã•ã„ã€‚
            </div>

            <div class="form-group">
                <label>ä¼æ¥­å</label>
                <input type="text" id="companyName" placeholder="ä¾‹: æ±äº¬é›»åŠ›">
            </div>

            <div class="form-group">
                <label>ä¼æ¥­ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color: #f44336;">*</span></label>
                <input type="text" id="companyAddress" placeholder="0x..." style="font-family: monospace;">
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    ä¼æ¥­ã®MetaMaskã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                </p>
            </div>

            <div class="form-group">
                <label>äº‹æ¥­ç¨®åˆ¥</label>
                <select id="businessType">
                    <option value="é›»æ°—">é›»æ°—</option>
                    <option value="ã‚¬ã‚¹">ã‚¬ã‚¹</option>
                    <option value="æ°´é“">æ°´é“</option>
                    <option value="ç·åˆ">ç·åˆï¼ˆé›»æ°—ãƒ»ã‚¬ã‚¹ãƒ»æ°´é“ï¼‰</option>
                </select>
            </div>

            <div class="form-group">
                <label>æœ‰åŠ¹æœŸé–“ï¼ˆå¹´ï¼‰</label>
                <select id="validityYears">
                    <option value="1">1å¹´</option>
                    <option value="2" selected>2å¹´</option>
                    <option value="3">3å¹´</option>
                    <option value="5">5å¹´</option>
                </select>
            </div>

            <button class="btn" id="mintBtn" onclick="mintCompanySBT()">ä¼æ¥­SBTã‚’ç™ºè¡Œ</button>

            <div id="mintStatus" class="status"></div>
        </div>
    </div>

    <script>
        const COMPANY_SBT_ADDRESS = "0xeF3E3cA47975f536092Dd55A9897E8251B4fC20C";
        
        const COMPANY_SBT_ABI = [
            "function mintCompanySBT(address to, string companyName, string businessType, uint256 validityPeriod) public returns (uint256)",
            "function hasValidCompanySBT(address account) public view returns (bool)",
            "function addressToTokenId(address) public view returns (uint256)",
            "function getCompanyData(uint256) public view returns (tuple(string companyName, string businessType, uint256 issuedDate, uint256 expiryDate, bool isValid))"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                
                if (network.chainId !== 11155111) {
                    document.getElementById('networkBadge').textContent = 'âŒ é–“é•ã£ãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯';
                    document.getElementById('networkBadge').style.background = '#f44336';
                    alert('Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                    return;
                }

                document.getElementById('networkBadge').textContent = 'Sepolia';
                document.getElementById('walletAddress').textContent = userAddress.substring(0, 6) + '...' + userAddress.substring(38);

                contract = new ethers.Contract(COMPANY_SBT_ADDRESS, COMPANY_SBT_ABI, signer);

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                alert('MetaMaskæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function mintCompanySBT() {
            if (!contract) {
                alert('å…ˆã«MetaMaskã‚’æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }

            const mintBtn = document.getElementById('mintBtn');
            mintBtn.disabled = true;

            try {
                const companyName = document.getElementById('companyName').value;
                const companyAddress = document.getElementById('companyAddress').value;
                const businessType = document.getElementById('businessType').value;
                const validityYears = parseInt(document.getElementById('validityYears').value);

                if (!companyName || !companyAddress) {
                    showStatus('error', 'âŒ ä¼æ¥­åã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    mintBtn.disabled = false;
                    return;
                }

                if (!ethers.utils.isAddress(companyAddress)) {
                    showStatus('error', 'âŒ æœ‰åŠ¹ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    mintBtn.disabled = false;
                    return;
                }

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const hasExisting = await contract.hasValidCompanySBT(companyAddress);
                if (hasExisting) {
                    showStatus('error', 'âŒ ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä¼æ¥­SBTã‚’ä¿æœ‰ã—ã¦ã„ã¾ã™');
                    mintBtn.disabled = false;
                    return;
                }

                showStatus('info', '<span class="loading"></span>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­...');

                // æœ‰åŠ¹æœŸé–“ã‚’ç§’ã«å¤‰æ›
                const validityPeriod = validityYears * 365 * 24 * 60 * 60;

                const tx = await contract.mintCompanySBT(
                    companyAddress,
                    companyName,
                    businessType,
                    validityPeriod
                );

                showStatus('info', '<span class="loading"></span>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã§ã®ç¢ºèªã‚’å¾…ã£ã¦ã„ã¾ã™...');

                const receipt = await tx.wait();

                showStatus('success', 
                    `âœ… ä¼æ¥­SBTç™ºè¡ŒæˆåŠŸï¼<br>
                    ä¼æ¥­å: ${companyName}<br>
                    äº‹æ¥­ç¨®åˆ¥: ${businessType}<br>
                    ç™ºè¡Œå…ˆ: ${companyAddress.substring(0, 6)}...${companyAddress.substring(38)}<br>
                    Tx: <a href="https://sepolia.etherscan.io/tx/${receipt.transactionHash}" target="_blank" class="link">${receipt.transactionHash.substring(0, 10)}...</a>`
                );

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('companyName').value = '';
                document.getElementById('companyAddress').value = '';

            } catch (error) {
                console.error('ç™ºè¡Œã‚¨ãƒ©ãƒ¼:', error);
                showStatus('error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }

            mintBtn.disabled = false;
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('mintStatus');
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = message;
        }
    </script>
</body>
</html>
