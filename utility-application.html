<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³å¥‘ç´„ç”³è¾¼</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .sbt-status {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .sbt-status.verified {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .sbt-status.not-verified {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .sbt-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .sbt-info-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 8px 0;
            font-size: 14px;
        }

        .utility-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .utility-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .utility-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .utility-card.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .utility-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .utility-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .utility-provider {
            font-size: 12px;
            color: #666;
        }

        .form-group {
            margin: 20px 0;
        }

        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .auto-filled {
            background: #e8f5e9;
            position: relative;
        }

        .auto-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        input:read-only {
            background: #f5f5f5;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .warning-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 768px) {
            .utility-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>âš¡ ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³å¥‘ç´„ç”³è¾¼</h1>
            <p style="color: #666; margin-top: 10px;">SBTã§æœ¬äººç¢ºèªæ¸ˆã¿ - ç°¡å˜ã«é›»æ°—ãƒ»ã‚¬ã‚¹ãƒ»æ°´é“ã‚’å¥‘ç´„</p>
        </div>

        <!-- SBT Verification -->
        <div class="card">
            <h2>ğŸ« SBTç¢ºèª</h2>
            
            <div id="sbtStatus" class="sbt-status not-verified">
                <p style="font-size: 18px; margin-bottom: 10px;">â³ SBTã‚’ç¢ºèªä¸­...</p>
                <button class="btn" onclick="verifySBT()" style="max-width: 300px; margin: 10px auto;">
                    MetaMaskæ¥ç¶šã—ã¦SBTã‚’ç¢ºèª
                </button>
            </div>

            <div id="sbtInfo" style="display: none;">
                <div class="sbt-info">
                    <h3 style="margin-bottom: 15px;">âœ… SBTä¿æœ‰è€…</h3>
                    <div class="sbt-info-item"><strong>User ID:</strong> <span id="sbtUserId"></span></div>
                    <div class="sbt-info-item"><strong>ç™ºè¡Œæ—¥:</strong> <span id="sbtIssuedDate"></span></div>
                    <div class="sbt-info-item"><strong>æœ‰åŠ¹æœŸé™:</strong> <span id="sbtExpiryDate"></span></div>
                    <div class="sbt-info-item"><strong>KYCãƒ¬ãƒ™ãƒ«:</strong> <span id="sbtKycLevel"></span></div>
                </div>
            </div>
        </div>

        <!-- Utility Selection -->
        <div class="card" id="utilitySelection" style="display: none;">
            <h2>ğŸ“‹ å¥‘ç´„ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ</h2>
            
            <div class="utility-grid">
                <div class="utility-card" onclick="toggleUtility('electric')">
                    <div class="utility-icon">ğŸ’¡</div>
                    <div class="utility-name">é›»æ°—</div>
                    <div class="utility-provider">â—‹â—‹é›»åŠ›</div>
                </div>
                
                <div class="utility-card" onclick="toggleUtility('gas')">
                    <div class="utility-icon">ğŸ”¥</div>
                    <div class="utility-name">ã‚¬ã‚¹</div>
                    <div class="utility-provider">â—‹â—‹ã‚¬ã‚¹</div>
                </div>
                
                <div class="utility-card" onclick="toggleUtility('water')">
                    <div class="utility-icon">ğŸ’§</div>
                    <div class="utility-name">æ°´é“</div>
                    <div class="utility-provider">æ¸‹è°·åŒºæ°´é“å±€</div>
                </div>
            </div>

            <div class="warning-box">
                <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> è¤‡æ•°é¸æŠå¯èƒ½ã§ã™ã€‚é¸æŠã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾ã—ã¦ä¸€æ‹¬ã§ç”³è¾¼ã§ãã¾ã™ã€‚
            </div>
        </div>

        <!-- Application Form -->
        <div class="card" id="applicationForm" style="display: none;">
            <h2>ğŸ“ å¥‘ç´„æƒ…å ±å…¥åŠ›</h2>
            
            <form id="contractForm">
                <div class="form-group">
                    <label>å¥‘ç´„è€…æ°å <span class="auto-badge">SBTã‹ã‚‰è‡ªå‹•å…¥åŠ›</span></label>
                    <input type="text" id="contractorName" readonly class="auto-filled">
                </div>

                <div class="form-group">
                    <label>è¨­ç½®å ´æ‰€ä½æ‰€ <span class="auto-badge">SBTã‹ã‚‰è‡ªå‹•å…¥åŠ›</span></label>
                    <input type="text" id="propertyAddress" readonly class="auto-filled">
                </div>

                <div class="form-group">
                    <label>å¥‘ç´„é–‹å§‹å¸Œæœ›æ—¥</label>
                    <input type="date" id="startDate" required>
                </div>

                <div class="form-group">
                    <label>é€£çµ¡å…ˆé›»è©±ç•ªå·</label>
                    <input type="tel" id="phoneNumber" placeholder="090-1234-5678" required>
                </div>

                <div class="form-group">
                    <label>é€£çµ¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="email" placeholder="example@example.com" required>
                </div>

                <div class="form-group">
                    <label>ç‰¹è¨˜äº‹é …ï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="notes" rows="3" placeholder="ã”è¦æœ›ãªã©ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„"></textarea>
                </div>

                <div class="warning-box">
                    <strong>ğŸ“Œ æ³¨æ„:</strong> 
                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                        <li>SBTã«ã‚ˆã‚‹æœ¬äººç¢ºèªæ¸ˆã¿ã®ãŸã‚ã€æ›¸é¡æå‡ºã¯ä¸è¦ã§ã™</li>
                        <li>å„äº‹æ¥­è€…ã‹ã‚‰ç¢ºèªã®é€£çµ¡ãŒå…¥ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</li>
                        <li>å®Ÿéš›ã®å¥‘ç´„é–‹å§‹æ—¥ã¯äº‹æ¥­è€…ã¨ã®èª¿æ•´ã«ã‚ˆã‚Šæ±ºå®šã—ã¾ã™</li>
                    </ul>
                </div>

                <button type="button" class="btn" onclick="submitApplication()">
                    ä¸€æ‹¬ç”³è¾¼ã‚’é€ä¿¡
                </button>
            </form>

            <div id="applicationStatus"></div>
        </div>
    </div>

    <script>
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹
        const SBT_CONTRACT_ADDRESS = "0xc9b1821620146021536f9962933773e5437693F9";
        
        const SBT_ABI = [
            "function addressToTokenId(address) public view returns (uint256)",
            "function getSBTData(uint256 tokenId) public view returns (tuple(string userId, uint256 issuedDate, uint256 expiryDate, bytes32 propertyHash, uint8 kycLevel, bool isValid))",
            "function isValidSBT(uint256 tokenId) public view returns (bool)"
        ];

        let provider;
        let signer;
        let sbtContract;
        let userAddress;
        let sbtData;
        let selectedUtilities = new Set();

        // SBTç¢ºèª
        async function verifySBT() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const network = await provider.getNetwork();
                
                if (network.chainId !== 11155111) {
                    showStatus('sbtStatus', 'error', 'âŒ Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                    return;
                }

                sbtContract = new ethers.Contract(SBT_CONTRACT_ADDRESS, SBT_ABI, provider);
                
                const tokenId = await sbtContract.addressToTokenId(userAddress);
                
                if (tokenId.toString() === '0') {
                    document.getElementById('sbtStatus').className = 'sbt-status not-verified';
                    document.getElementById('sbtStatus').innerHTML = `
                        <p style="font-size: 18px; color: #c62828;">âŒ SBTã‚’ä¿æœ‰ã—ã¦ã„ã¾ã›ã‚“</p>
                        <p style="font-size: 14px; color: #666; margin-top: 10px;">
                            ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãšå…¥å±…è€…è¨¼æ˜SBTã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
                        </p>
                    `;
                    return;
                }
                
                sbtData = await sbtContract.getSBTData(tokenId);
                const isValid = await sbtContract.isValidSBT(tokenId);
                
                if (!isValid) {
                    document.getElementById('sbtStatus').className = 'sbt-status not-verified';
                    document.getElementById('sbtStatus').innerHTML = `
                        <p style="font-size: 18px; color: #c62828;">âŒ SBTãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™</p>
                    `;
                    return;
                }
                
                // SBTæƒ…å ±ã‚’è¡¨ç¤º
                const issuedDate = new Date(sbtData.issuedDate.toNumber() * 1000);
                const expiryDate = new Date(sbtData.expiryDate.toNumber() * 1000);
                
                document.getElementById('sbtUserId').textContent = sbtData.userId;
                document.getElementById('sbtIssuedDate').textContent = issuedDate.toLocaleDateString('ja-JP');
                document.getElementById('sbtExpiryDate').textContent = expiryDate.toLocaleDateString('ja-JP');
                document.getElementById('sbtKycLevel').textContent = sbtData.kycLevel === 1 ? 'åŸºæœ¬èªè¨¼' : 'æ‹¡å¼µèªè¨¼';
                
                document.getElementById('sbtStatus').className = 'sbt-status verified';
                document.getElementById('sbtStatus').innerHTML = `
                    <p style="font-size: 18px; color: #2e7d32; margin-bottom: 10px;">âœ… SBTç¢ºèªå®Œäº†</p>
                    <p style="font-size: 14px; color: #666;">æœ¬äººç¢ºèªæ¸ˆã¿ã§ã™ã€‚ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³å¥‘ç´„ã®ç”³è¾¼ãŒã§ãã¾ã™ã€‚</p>
                `;
                document.getElementById('sbtInfo').style.display = 'block';
                document.getElementById('utilitySelection').style.display = 'block';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ï¼ˆãƒ‡ãƒ¢ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰
                document.getElementById('contractorName').value = 'å±±ç”° å¤ªéƒ';
                document.getElementById('propertyAddress').value = 'æ±äº¬éƒ½æ¸‹è°·åŒºâ—‹â—‹1-2-3 â—‹â—‹ãƒãƒ³ã‚·ãƒ§ãƒ³ 101å·å®¤';
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¥‘ç´„é–‹å§‹æ—¥ã‚’è¨­å®šï¼ˆ1é€±é–“å¾Œï¼‰
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                document.getElementById('startDate').value = nextWeek.toISOString().split('T')[0];
                
            } catch (error) {
                console.error('SBTç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('sbtStatus').className = 'sbt-status not-verified';
                document.getElementById('sbtStatus').innerHTML = `
                    <p style="font-size: 18px; color: #c62828;">âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">${error.message}</p>
                `;
            }
        }

        // ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³é¸æŠãƒˆã‚°ãƒ«
        function toggleUtility(utilityType) {
            const card = event.currentTarget;
            
            if (selectedUtilities.has(utilityType)) {
                selectedUtilities.delete(utilityType);
                card.classList.remove('selected');
            } else {
                selectedUtilities.add(utilityType);
                card.classList.add('selected');
            }
            
            // 1ã¤ã§ã‚‚é¸æŠã•ã‚Œã¦ã„ã‚Œã°ç”³è¾¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            if (selectedUtilities.size > 0) {
                document.getElementById('applicationForm').style.display = 'block';
                document.getElementById('applicationForm').scrollIntoView({ behavior: 'smooth' });
            } else {
                document.getElementById('applicationForm').style.display = 'none';
            }
        }

        // ç”³è¾¼é€ä¿¡
        function submitApplication() {
            if (selectedUtilities.size === 0) {
                showApplicationStatus('error', 'âŒ å¥‘ç´„ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            const email = document.getElementById('email').value;
            
            if (!phoneNumber || !email) {
                showApplicationStatus('error', 'âŒ é€£çµ¡å…ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ‡ãƒ¢ç”¨ï¼šå®Ÿéš›ã«ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã«é€ä¿¡
            showApplicationStatus('info', '<span class="loading"></span>ç”³è¾¼ã‚’é€ä¿¡ä¸­...');
            
            setTimeout(() => {
                const utilities = Array.from(selectedUtilities).map(u => {
                    const names = { electric: 'é›»æ°—', gas: 'ã‚¬ã‚¹', water: 'æ°´é“' };
                    return names[u];
                }).join('ã€');
                
                showApplicationStatus('success', `
                    âœ… ç”³è¾¼å®Œäº†ï¼<br><br>
                    <strong>é¸æŠã‚µãƒ¼ãƒ“ã‚¹:</strong> ${utilities}<br>
                    <strong>å¥‘ç´„è€…:</strong> ${document.getElementById('contractorName').value}<br>
                    <strong>è¨­ç½®å ´æ‰€:</strong> ${document.getElementById('propertyAddress').value}<br>
                    <strong>é–‹å§‹å¸Œæœ›æ—¥:</strong> ${document.getElementById('startDate').value}<br><br>
                    å„äº‹æ¥­è€…ã‹ã‚‰ç¢ºèªã®é€£çµ¡ãŒå…¥ã‚Šã¾ã™ã€‚<br>
                    SBTã«ã‚ˆã‚‹æœ¬äººç¢ºèªæ¸ˆã¿ã®ãŸã‚ã€æ›¸é¡æå‡ºã¯ä¸è¦ã§ã™ã€‚
                `);
            }, 2000);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `sbt-status ${type}`;
            element.innerHTML = message;
        }

        function showApplicationStatus(type, message) {
            document.getElementById('applicationStatus').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
        window.addEventListener('load', () => {
            // è‡ªå‹•ã§SBTç¢ºèªã‚’è©¦ã¿ã‚‹ï¼ˆMetaMaskãŒã™ã§ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if (window.ethereum && window.ethereum.selectedAddress) {
                verifySBT();
            }
        });
    </script>
</body>
</html>
