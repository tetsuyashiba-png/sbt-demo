<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - è³ƒè²¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-number.warning {
            color: #ff9800;
        }

        .stat-number.danger {
            color: #f44336;
        }

        .stat-number.success {
            color: #4caf50;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9ff;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.warning {
            background: #fff3cd;
            color: #f57c00;
        }

        .badge.danger {
            background: #ffebee;
            color: #c62828;
        }

        .badge.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.small {
            padding: 5px 15px;
            font-size: 12px;
        }

        .btn.danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .btn.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“Š ç®¡ç†ç”»é¢</h1>
            <p style="color: #666; margin-top: 10px;">è³ƒè²¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - SBTç™ºè¡Œãƒ»å…¥é‡‘ç®¡ç†</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ç™ºè¡Œæ¸ˆã¿SBT</div>
                <div class="stat-number" id="totalSBTs">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label success">ä»Šæœˆå…¥é‡‘æ¸ˆã¿</div>
                <div class="stat-number success" id="paidCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label warning">æœªå…¥é‡‘</div>
                <div class="stat-number warning" id="unpaidCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å…¥é‡‘ç‡</div>
                <div class="stat-number" id="paymentRate">-%</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="tab active" onclick="switchTab('all')">ã™ã¹ã¦</button>
            <button class="tab" onclick="switchTab('paid')">å…¥é‡‘æ¸ˆã¿</button>
            <button class="tab" onclick="switchTab('unpaid')">æœªå…¥é‡‘</button>
        </div>

        <!-- SBT List -->
        <div class="card">
            <h2>
                <span>ğŸ« ç™ºè¡Œæ¸ˆã¿SBTä¸€è¦§</span>
                <button class="btn" onclick="connectWallet()">MetaMaskæ¥ç¶š</button>
            </h2>
            
            <div id="connectionStatus"></div>
            
            <div class="table-container">
                <table id="sbtTable">
                    <thead>
                        <tr>
                            <th>ãƒˆãƒ¼ã‚¯ãƒ³ID</th>
                            <th>User ID</th>
                            <th>ç™ºè¡Œæ—¥</th>
                            <th>æœ‰åŠ¹æœŸé™</th>
                            <th>KYCãƒ¬ãƒ™ãƒ«</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>å…¥é‡‘çŠ¶æ³</th>
                            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                        </tr>
                    </thead>
                    <tbody id="sbtTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                MetaMaskã‚’æ¥ç¶šã—ã¦ãã ã•ã„
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment History -->
        <div class="card">
            <h2>ğŸ’° å…¥é‡‘å±¥æ­´</h2>
            
            <div class="table-container">
                <table id="paymentTable">
                    <thead>
                        <tr>
                            <th>æ”¯æ‰•æ—¥æ™‚</th>
                            <th>å…¥å±…è€…</th>
                            <th>é‡‘é¡</th>
                            <th>å¤§å®¶å—å–é¡</th>
                            <th>ç®¡ç†ä¼šç¤¾å—å–é¡</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        </tr>
                    </thead>
                    <tbody id="paymentTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Accounting Integration -->
        <div class="card">
            <h2>ğŸ“Š è‡ªå‹•çµŒç†é€£æº</h2>
            
            <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
                <h3 style="color: #2e7d32; margin-bottom: 10px;">âœ… è³ƒè²¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é€£æºæ¸ˆã¿</h3>
                <p style="color: #666; line-height: 1.6;">
                    å…¥é‡‘æƒ…å ±ã¯è‡ªå‹•çš„ã«è³ƒè²¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¸é€ä¿¡ã•ã‚Œã€æ¶ˆè¾¼å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™ã€‚
                </p>
            </div>

            <div class="table-container">
                <table id="accountingTable">
                    <thead>
                        <tr>
                            <th>å‡¦ç†æ—¥æ™‚</th>
                            <th>å–å¼•å†…å®¹</th>
                            <th>é‡‘é¡</th>
                            <th>é€£æºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>è³ƒè²¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </th>
                        </tr>
                    </thead>
                    <tbody id="accountingTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #2196f3;">
                <h4 style="color: #1565c0; margin-bottom: 10px;">ğŸ”„ è‡ªå‹•åŒ–ã•ã‚Œã¦ã„ã‚‹å‡¦ç†</h4>
                <ul style="margin-left: 20px; color: #666; line-height: 1.8;">
                    <li>å…¥é‡‘ç¢ºèªå¾Œã€è‡ªå‹•ã§è³ƒè²¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ä»•è¨³ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡</li>
                    <li>å£²æ›é‡‘ã®è‡ªå‹•æ¶ˆè¾¼å‡¦ç†</li>
                    <li>å¤§å®¶ãƒ»ç®¡ç†ä¼šç¤¾ã¸ã®åˆ†é…è¨˜éŒ²ã‚’è‡ªå‹•ç™»éŒ²</li>
                    <li>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®è‡ªå‹•ç”Ÿæˆ</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: #667eea;">ğŸ’Œ ç£ä¿ƒãƒ¡ãƒ¼ãƒ«é€ä¿¡</h2>
                <span class="close" onclick="closeReminderModal()">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>é€ä¿¡å…ˆ:</strong> <span id="reminderTarget"></span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ä»¶å:</label>
                <input type="text" id="reminderSubject" value="ã€é‡è¦ã€‘å®¶è³ƒã®ãŠæ”¯æ‰•ã„ã«ã¤ã„ã¦" 
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">æœ¬æ–‡:</label>
                <textarea id="reminderMessage" rows="8">ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

ä»Šæœˆã®å®¶è³ƒã®ãŠæ”¯æ‰•ã„ãŒç¢ºèªã§ãã¦ãŠã‚Šã¾ã›ã‚“ã€‚
ãŠæ‰‹æ•°ã§ã™ãŒã€ãŠæ—©ã‚ã®ãŠæ”¯æ‰•ã„ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ã™ã§ã«ãŠæ”¯æ‰•ã„ã„ãŸã ã„ã¦ã„ã‚‹å ´åˆã¯ã€æœ¬ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</textarea>
            </div>
            
            <button class="btn" onclick="sendReminder()" style="width: 100%;">
                ç£ä¿ƒãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
            </button>
            
            <div id="reminderStatus"></div>
        </div>
    </div>

    <script>
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹
        const SBT_CONTRACT_ADDRESS = "0xd9145CCE52D386f254917e481eB44e9943F39138";
        const RENT_PAYMENT_ADDRESS = "0x77d1251Edac77cF4e4b8339dD74CECD61f90902b";
        const TOKEN_ADDRESS = "0x179AFB0E44838E42D30953Da6f344479558e2Ef3";
        
        const SBT_ABI = [
            "function addressToTokenId(address) external view returns (uint256)",
            "function getSBTData(uint256 tokenId) external view returns (tuple(string userId, uint256 issuedDate, uint256 expiryDate, bytes32 propertyHash, uint8 kycLevel, bool isValid))",
            "function isValidSBT(uint256 tokenId) external view returns (bool)",
            "function hasValidSBT(address account) external view returns (bool)",
            "function ownerOf(uint256 tokenId) external view returns (address)"
        ];

        const RENT_PAYMENT_ABI = [
            "function getTotalPayments() external view returns (uint256)",
            "function getPaymentDetails(uint256 paymentId) external view returns (address tenant, uint256 amount, uint256 timestamp, address tokenAddress, bool isDistributed)",
            "function getTenantPayments(address tenant) external view returns (uint256[] memory)"
        ];

        const TOKEN_ABI = [
            "function decimals() external view returns (uint8)"
        ];

        let provider;
        let sbtContract;
        let rentContract;
        let tokenContract;
        let currentFilter = 'all';
        let allSBTsData = [];
        let currentReminderAddress;

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼');
                    return;
                }

                showStatus('connectionStatus', 'info', '<span class="loading"></span>æ¥ç¶šä¸­...');

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                const network = await provider.getNetwork();
                
                if (network.chainId !== 11155111) {
                    showStatus('connectionStatus', 'error', 'âŒ Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                    return;
                }

                sbtContract = new ethers.Contract(SBT_CONTRACT_ADDRESS, SBT_ABI, provider);
                rentContract = new ethers.Contract(RENT_PAYMENT_ADDRESS, RENT_PAYMENT_ABI, provider);
                tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, provider);

                showStatus('connectionStatus', 'success', 'âœ… æ¥ç¶šå®Œäº†ï¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');

                await loadData();

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                showStatus('connectionStatus', 'error', 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                // ãƒ‡ãƒ¢ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                document.getElementById('totalSBTs').textContent = '1';
                document.getElementById('paidCount').textContent = '1';
                document.getElementById('unpaidCount').textContent = '0';
                document.getElementById('paymentRate').textContent = '100';

                await loadSBTList();
                await loadPaymentHistory();
                await loadAccountingData();

                showStatus('connectionStatus', 'success', 'âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');

            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('connectionStatus', 'error', 'âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // SBTä¸€è¦§èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„ç‰ˆï¼‰
        async function loadSBTList() {
            try {
                const tenantAddress = "0xEA61DAc26Dee68C9a56fBA6671aB6c4E2C7F8A11";
                
                // hasValidSBTã§å­˜åœ¨ç¢ºèª
                const hasValid = await sbtContract.hasValidSBT(tenantAddress);
                
                let tokenId;
                try {
                    tokenId = await sbtContract.addressToTokenId(tenantAddress);
                } catch (error) {
                    console.error('addressToTokenId ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('sbtTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                SBTãŒç™ºè¡Œã•ã‚Œã¦ã„ãªã„ã‹ã€å–å¾—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                if (tokenId.toNumber() === 0) {
                    document.getElementById('sbtTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                ã¾ã SBTãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const sbtData = await sbtContract.getSBTData(tokenId);
                const isValid = await sbtContract.isValidSBT(tokenId);
                
                const issuedDate = new Date(sbtData.issuedDate.toNumber() * 1000);
                const expiryDate = new Date(sbtData.expiryDate.toNumber() * 1000);
                
                const payments = await rentContract.getTenantPayments(tenantAddress);
                const hasPaid = payments.length > 0;
                
                allSBTsData = [{
                    tokenId: tokenId.toNumber(),
                    userId: sbtData.userId,
                    issuedDate: issuedDate,
                    expiryDate: expiryDate,
                    kycLevel: sbtData.kycLevel,
                    isValid: isValid,
                    hasPaid: hasPaid,
                    address: tenantAddress
                }];
                
                renderSBTTable();

            } catch (error) {
                console.error('SBTä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('sbtTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #f44336;">
                            ã‚¨ãƒ©ãƒ¼: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // SBTãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderSBTTable() {
            let filteredData = allSBTsData;
            
            if (currentFilter === 'paid') {
                filteredData = allSBTsData.filter(sbt => sbt.hasPaid);
            } else if (currentFilter === 'unpaid') {
                filteredData = allSBTsData.filter(sbt => !sbt.hasPaid);
            }
            
            if (filteredData.length === 0) {
                document.getElementById('sbtTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                            è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredData.forEach(sbt => {
                const statusBadge = sbt.isValid ? 
                    '<span class="badge success">âœ… æœ‰åŠ¹</span>' : 
                    '<span class="badge danger">âŒ ç„¡åŠ¹</span>';
                
                const paymentBadge = sbt.hasPaid ? 
                    '<span class="badge success">âœ… å…¥é‡‘æ¸ˆã¿</span>' : 
                    '<span class="badge warning">âš ï¸ æœªå…¥é‡‘</span>';
                
                const actionBtn = sbt.hasPaid ? 
                    '<button class="btn small" disabled>ç£ä¿ƒä¸è¦</button>' : 
                    `<button class="btn small warning" onclick="openReminderModal('${sbt.address}', '${sbt.userId}')">ç£ä¿ƒã™ã‚‹</button>`;
                
                html += `
                    <tr>
                        <td>${sbt.tokenId}</td>
                        <td>${sbt.userId}</td>
                        <td>${sbt.issuedDate.toLocaleDateString('ja-JP')}</td>
                        <td>${sbt.expiryDate.toLocaleDateString('ja-JP')}</td>
                        <td>${sbt.kycLevel === 1 ? 'åŸºæœ¬' : 'æ‹¡å¼µ'}</td>
                        <td>${statusBadge}</td>
                        <td>${paymentBadge}</td>
                        <td>${actionBtn}</td>
                    </tr>
                `;
            });
            
            document.getElementById('sbtTableBody').innerHTML = html;
        }

        // å…¥é‡‘å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadPaymentHistory() {
            try {
                const totalPayments = await rentContract.getTotalPayments();
                
                if (totalPayments.toNumber() === 0) {
                    document.getElementById('paymentTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                ã¾ã æ”¯æ‰•ã„å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const decimals = await tokenContract.decimals();
                let html = '';
                
                for (let i = totalPayments.toNumber() - 1; i >= 0; i--) {
                    const payment = await rentContract.getPaymentDetails(i);
                    const amount = ethers.utils.formatUnits(payment.amount, decimals);
                    const landlordAmount = (parseFloat(amount) * 0.95).toFixed(0);
                    const managementAmount = (parseFloat(amount) * 0.05).toFixed(0);
                    const date = new Date(payment.timestamp.toNumber() * 1000);
                    
                    const statusBadge = payment.isDistributed ? 
                        '<span class="badge success">âœ… åˆ†é…æ¸ˆã¿</span>' : 
                        '<span class="badge warning">â³ å‡¦ç†ä¸­</span>';
                    
                    html += `
                        <tr>
                            <td>${date.toLocaleString('ja-JP')}</td>
                            <td>${payment.tenant.substring(0, 6)}...${payment.tenant.substring(38)}</td>
                            <td>${parseFloat(amount).toLocaleString()} TJPY</td>
                            <td>${parseInt(landlordAmount).toLocaleString()} TJPY</td>
                            <td>${parseInt(managementAmount).toLocaleString()} TJPY</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                }
                
                document.getElementById('paymentTableBody').innerHTML = html;

            } catch (error) {
                console.error('å…¥é‡‘å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // çµŒç†é€£æºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAccountingData() {
            try {
                const totalPayments = await rentContract.getTotalPayments();
                
                if (totalPayments.toNumber() === 0) {
                    document.getElementById('accountingTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                ã¾ã é€£æºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const decimals = await tokenContract.decimals();
                let html = '';
                
                for (let i = totalPayments.toNumber() - 1; i >= 0; i--) {
                    const payment = await rentContract.getPaymentDetails(i);
                    const amount = ethers.utils.formatUnits(payment.amount, decimals);
                    const date = new Date(payment.timestamp.toNumber() * 1000);
                    const syncDate = new Date(date.getTime() + 5000);
                    
                    const statusBadge = payment.isDistributed ? 
                        '<span class="badge success">âœ… é€£æºå®Œäº†</span>' : 
                        '<span class="badge warning">â³ å‡¦ç†ä¸­</span>';
                    
                    html += `
                        <tr>
                            <td>${syncDate.toLocaleString('ja-JP')}</td>
                            <td>å®¶è³ƒå…¥é‡‘ - ${payment.tenant.substring(0, 6)}...${payment.tenant.substring(38)}</td>
                            <td>${parseFloat(amount).toLocaleString()} å††</td>
                            <td>${statusBadge}</td>
                            <td><span class="badge info">è‡ªå‹•æ¶ˆè¾¼å®Œäº†</span></td>
                        </tr>
                    `;
                }
                
                document.getElementById('accountingTableBody').innerHTML = html;

            } catch (error) {
                console.error('çµŒç†ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderSBTTable();
        }

        // ç£ä¿ƒãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openReminderModal(address, userId) {
            currentReminderAddress = address;
            document.getElementById('reminderTarget').textContent = `${userId} (${address.substring(0, 6)}...${address.substring(38)})`;
            document.getElementById('reminderModal').classList.add('show');
        }

        // ç£ä¿ƒãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeReminderModal() {
            document.getElementById('reminderModal').classList.remove('show');
            document.getElementById('reminderStatus').innerHTML = '';
        }

        // ç£ä¿ƒé€ä¿¡
        function sendReminder() {
            const subject = document.getElementById('reminderSubject').value;
            const message = document.getElementById('reminderMessage').value;
            
            if (!subject || !message) {
                showReminderStatus('error', 'âŒ ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            showReminderStatus('info', '<span class="loading"></span>é€ä¿¡ä¸­...');
            
            setTimeout(() => {
                showReminderStatus('success', `âœ… ç£ä¿ƒãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ<br><br>é€ä¿¡å…ˆ: ${currentReminderAddress}`);
                
                setTimeout(() => {
                    closeReminderModal();
                }, 2000);
            }, 1500);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, type, message) {
            document.getElementById(elementId).innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        function showReminderStatus(type, message) {
            document.getElementById('reminderStatus').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('reminderModal');
            if (event.target === modal) {
                closeReminderModal();
            }
        }
    </script>
</body>
</html>
